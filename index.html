<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>석리송의 교육용 SVG 아이콘 라이브러리</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' fill='none'%3E%3Cdefs%3E%3ClinearGradient id='fg' x1='0' y1='0' x2='64' y2='64' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0%25' stop-color='%232563eb'/%3E%3Cstop offset='100%25' stop-color='%2306b6d4'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='4' y='4' width='56' height='56' rx='16' fill='%23eff6ff'/%3E%3Crect x='4' y='4' width='56' height='56' rx='16' fill='none' stroke='%232563eb' stroke-width='1.5' opacity='0.2'/%3E%3Cg transform='translate(14,12) scale(1.5)' stroke='url(%23fg)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' fill='none'%3E%3Cpath d='M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20'/%3E%3Cpath d='M9 10l2 2 4-4' opacity='0.7'/%3E%3C/g%3E%3C/svg%3E">
<script src="https://cdn.jsdelivr.net/npm/jszip@3/dist/jszip.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#f8fafc;--card:#fff;--text:#1e293b;--sub:#64748b;--border:#e2e8f0;--accent:#2563eb;--radius:12px}
@media(prefers-color-scheme:dark){:root{--bg:#0f172a;--card:#1e293b;--text:#f1f5f9;--sub:#94a3b8;--border:#334155;--accent:#60a5fa}}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
header{text-align:center;padding:2rem 1rem 1rem;max-width:800px;margin:0 auto}
h1{font-size:1.5rem;font-weight:700;margin-bottom:.2rem}
.subtitle{color:var(--sub);font-size:.85rem;margin-bottom:1rem}
.search-box{position:relative;max-width:500px;margin:0 auto .8rem}
.search-box input{width:100%;padding:.65rem 1rem .65rem 2.4rem;border:1.5px solid var(--border);border-radius:var(--radius);background:var(--card);color:var(--text);font-size:.9rem;outline:none}
.search-box input:focus{border-color:var(--accent)}
.search-box svg{position:absolute;left:.7rem;top:50%;transform:translateY(-50%);width:16px;height:16px;stroke:var(--sub)}
.toolbar{display:flex;justify-content:center;align-items:center;gap:.8rem;margin-bottom:.5rem;flex-wrap:wrap}
.stats{color:var(--sub);font-size:.8rem}
.view-btns{display:flex;gap:2px;border:1.5px solid var(--border);border-radius:8px;overflow:hidden}
.view-btns button{padding:.3rem .6rem;border:none;background:var(--card);color:var(--sub);font-size:.75rem;cursor:pointer}
.view-btns button.active{background:var(--accent);color:#fff}
.doc-link{font-size:.75rem;color:var(--accent);text-decoration:none;border:1px solid var(--accent);padding:.25rem .5rem;border-radius:6px;cursor:pointer}
.doc-link:hover{background:var(--accent);color:#fff}
nav{display:flex;flex-wrap:wrap;justify-content:center;gap:.35rem;padding:0 1rem;margin-bottom:1.2rem;max-width:1100px;margin-left:auto;margin-right:auto}
nav button{padding:.3rem .6rem;border:1.5px solid var(--border);border-radius:8px;background:var(--card);color:var(--sub);font-size:.72rem;cursor:pointer;transition:.15s}
nav button:hover,nav button.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* 포맷 선택 바 */
.format-bar{display:flex;justify-content:center;align-items:center;gap:.6rem;padding:.6rem 1rem;margin:0 auto .8rem;max-width:700px;flex-wrap:wrap}
.format-bar label{font-size:.78rem;font-weight:600;color:var(--sub);white-space:nowrap}
.format-btns{display:flex;gap:2px;border:1.5px solid var(--border);border-radius:8px;overflow:hidden}
.format-btns button{padding:.3rem .55rem;border:none;background:var(--card);color:var(--sub);font-size:.72rem;cursor:pointer;transition:.15s;white-space:nowrap}
.format-btns button.active{background:var(--accent);color:#fff}
.format-btns button:hover:not(.active){background:color-mix(in srgb,var(--accent) 10%,var(--card))}
.dl-all-btn{font-size:.73rem;color:#fff;background:var(--accent);border:none;padding:.35rem .7rem;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:.3rem;transition:.15s}
.dl-all-btn:hover{opacity:.85}
.dl-all-btn:disabled{opacity:.5;cursor:not-allowed}
.dl-all-btn svg{width:14px;height:14px;stroke:currentColor;fill:none}

/* 그리드 뷰 */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(88px,1fr));gap:.7rem;padding:0 1rem 2rem;max-width:1200px;margin:0 auto}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:.5rem;text-align:center;cursor:pointer;transition:.15s;position:relative}
.card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
.card.selected{border-color:var(--accent);background:color-mix(in srgb,var(--accent) 8%,var(--card));box-shadow:0 0 0 2px color-mix(in srgb,var(--accent) 25%,transparent)}
.card img{width:52px;height:52px;display:block;margin:0 auto .2rem;pointer-events:none}
.card span{font-size:.6rem;color:var(--sub);display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;pointer-events:none}
.card .card-info{position:absolute;top:4px;right:4px;width:20px;height:20px;border-radius:50%;background:var(--sub);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:.15s}
.card:hover .card-info{opacity:1}
.card .card-info svg{width:12px;height:12px;stroke:#fff;fill:none}
.card .card-check{position:absolute;top:4px;left:4px;width:18px;height:18px;border-radius:50%;border:1.5px solid var(--border);background:var(--card);display:flex;align-items:center;justify-content:center;opacity:0;transition:.15s}
.card:hover .card-check,.card.selected .card-check{opacity:1}
.card.selected .card-check{background:var(--accent);border-color:var(--accent)}
.card.selected .card-check svg{stroke:#fff}
.card .card-check svg{width:12px;height:12px;stroke:var(--sub);fill:none}

/* 선택 도구 바 */
.select-bar{display:none;justify-content:center;align-items:center;gap:.8rem;padding:.5rem 1rem;margin:0 auto .5rem;max-width:700px;flex-wrap:wrap;background:color-mix(in srgb,var(--accent) 8%,var(--bg));border-radius:10px}
.select-bar.show{display:flex}
.select-bar .sel-count{font-size:.78rem;color:var(--accent);font-weight:600}
.select-bar button{font-size:.73rem;padding:.3rem .65rem;border-radius:8px;cursor:pointer;border:1.5px solid var(--accent);transition:.15s}
.select-bar .sel-all-btn{background:transparent;color:var(--accent)}
.select-bar .sel-all-btn:hover{background:var(--accent);color:#fff}
.select-bar .sel-clear-btn{background:transparent;color:var(--sub);border-color:var(--border)}
.select-bar .sel-clear-btn:hover{border-color:var(--sub)}
.select-bar .sel-dl-btn{background:var(--accent);color:#fff;border-color:var(--accent);display:flex;align-items:center;gap:.3rem}
.select-bar .sel-dl-btn:hover{opacity:.85}
.select-bar .sel-dl-btn svg{width:13px;height:13px;stroke:currentColor;fill:none}

/* 테이블(문서) 뷰 */
.doc-table{width:100%;max-width:1100px;margin:0 auto 2rem;border-collapse:collapse;padding:0 1rem}
.doc-table th{background:var(--accent);color:#fff;padding:.5rem .7rem;font-size:.75rem;text-align:left;position:sticky;top:0}
.doc-table td{padding:.45rem .7rem;border-bottom:1px solid var(--border);font-size:.78rem;vertical-align:middle}
.doc-table tr:hover td{background:color-mix(in srgb,var(--accent) 5%,var(--card))}
.doc-table img{width:36px;height:36px;vertical-align:middle}
.doc-table .fname{font-family:monospace;font-size:.7rem;color:var(--sub)}
.doc-table .cat-badge{display:inline-block;padding:1px 6px;border-radius:4px;font-size:.65rem;background:color-mix(in srgb,var(--accent) 12%,var(--card));color:var(--accent)}
.doc-table .row-dl{background:none;border:1px solid var(--accent);color:var(--accent);padding:2px 8px;border-radius:6px;font-size:.68rem;cursor:pointer;transition:.15s}
.doc-table .row-dl:hover{background:var(--accent);color:#fff}
.doc-table tr.selected td{background:color-mix(in srgb,var(--accent) 8%,var(--card))}
.doc-table .row-chk{width:15px;height:15px;accent-color:var(--accent);cursor:pointer;vertical-align:middle;margin-right:4px}

.hidden{display:none!important}

/* 모달 */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:100;justify-content:center;align-items:center}
.modal-bg.show{display:flex}
.modal{background:var(--card);border-radius:16px;padding:1.5rem;max-width:420px;width:92%;max-height:85vh;overflow-y:auto;position:relative}
.modal .close{position:absolute;top:.7rem;right:.7rem;background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--sub)}
.modal img{width:100px;height:100px;display:block;margin:0 auto .8rem}
.modal h2{font-size:1rem;text-align:center;margin-bottom:.2rem}
.modal .cat{text-align:center;color:var(--accent);font-size:.78rem;margin-bottom:.6rem}
.modal .desc{color:var(--sub);font-size:.82rem;margin-bottom:.4rem}
.modal .meta{font-size:.75rem;margin-bottom:.8rem;padding:.5rem;background:var(--bg);border-radius:8px}
.modal .meta div{margin-bottom:.3rem}
.modal .meta strong{color:var(--sub);font-size:.7rem}
.modal .dl-section{margin-bottom:.6rem}
.modal .dl-section label{font-size:.72rem;color:var(--sub);font-weight:600;display:block;margin-bottom:.3rem}
.modal .dl-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.35rem}
.modal .dl-grid button{padding:.4rem .3rem;border:1.5px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);font-size:.72rem;cursor:pointer;transition:.15s;text-align:center}
.modal .dl-grid button:hover{border-color:var(--accent);color:var(--accent)}
.modal .dl-grid button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.modal .dl-grid button .sz{display:block;font-size:.62rem;color:var(--sub);margin-top:1px}
.modal .dl-grid button.primary .sz{color:rgba(255,255,255,.7)}
.modal .btns{display:flex;gap:.5rem}
.modal .btns button{flex:1;padding:.45rem;border:1.5px solid var(--accent);border-radius:8px;background:transparent;color:var(--accent);font-size:.78rem;cursor:pointer}
.modal .btns button:first-child{background:var(--accent);color:#fff}
.empty{text-align:center;color:var(--sub);padding:3rem;grid-column:1/-1}

/* 색상 커스텀 */
.color-edit-btn{width:100%;margin-top:.5rem;padding:.5rem;border:1.5px dashed var(--accent);border-radius:8px;background:transparent;color:var(--accent);font-size:.78rem;cursor:pointer;transition:.15s}
.color-edit-btn:hover{background:rgba(37,99,235,.06)}
.modal.color-mode{max-width:560px}
.color-panel{display:none;margin-top:.8rem;padding:.8rem;background:var(--bg);border-radius:12px}
.color-panel.show{display:block}
.color-panel h3{font-size:.85rem;margin-bottom:.6rem;text-align:center}
.color-row{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem}
.color-row label{font-size:.72rem;color:var(--sub);min-width:80px;flex-shrink:0}
.color-row input[type="color"]{width:32px;height:32px;border:2px solid var(--border);border-radius:8px;cursor:pointer;padding:1px;background:var(--card);-webkit-appearance:none;appearance:none}
.color-row input[type="color"]::-webkit-color-swatch-wrapper{padding:1px}
.color-row input[type="color"]::-webkit-color-swatch{border-radius:5px;border:none}
.color-row .hex-input{width:76px;font-size:.72rem;font-family:monospace;padding:.25rem .4rem;border:1.5px solid var(--border);border-radius:6px;background:var(--card);color:var(--text)}
.preset-section{margin:.6rem 0}
.preset-section>label{font-size:.72rem;color:var(--sub);font-weight:600;display:block;margin-bottom:.3rem}
.preset-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.3rem}
.preset-btn{padding:.35rem .2rem;border:1.5px solid var(--border);border-radius:8px;background:var(--card);cursor:pointer;text-align:center;font-size:.62rem;color:var(--text);transition:.15s}
.preset-btn:hover{border-color:var(--accent)}
.preset-preview{display:flex;gap:2px;justify-content:center;margin-bottom:2px}
.preset-swatch{width:12px;height:12px;border-radius:3px;border:1px solid rgba(0,0,0,.1)}
.color-preview-wrap{text-align:center;margin:.6rem 0}
.color-preview-wrap svg{width:100px;height:100px}
.color-actions{display:flex;gap:.35rem;margin-top:.5rem;flex-wrap:wrap}
.color-actions button{flex:1;padding:.4rem;border:1.5px solid var(--accent);border-radius:8px;font-size:.72rem;cursor:pointer;transition:.15s;min-width:0;white-space:nowrap}
.color-actions .cdl{background:var(--accent);color:#fff;border-color:var(--accent)}
.color-actions .ccopy{background:transparent;color:var(--accent)}
.color-actions .creset{background:transparent;color:var(--sub);border-color:var(--border)}
.png-sizes{display:flex;gap:.3rem;margin-top:.35rem}
.png-sizes button{flex:1;padding:.3rem;border:1.5px solid var(--border);border-radius:6px;background:var(--card);color:var(--text);font-size:.65rem;cursor:pointer;transition:.15s}
.png-sizes button:hover{border-color:var(--accent);color:var(--accent)}

/* 전체 색상 변경 */
.global-color-btn{padding:.3rem .6rem;border:1.5px solid var(--accent);border-radius:8px;background:transparent;color:var(--accent);font-size:.75rem;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:.3rem}
.global-color-btn:hover{background:var(--accent);color:#fff}
.global-color-btn.active{background:var(--accent);color:#fff}
.global-panel-wrap{position:relative;display:inline-block}
.global-panel{display:none;position:absolute;top:100%;left:50%;transform:translateX(-50%);margin-top:.5rem;background:var(--card);border:1.5px solid var(--border);border-radius:12px;padding:.8rem;z-index:50;width:320px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
.global-panel.show{display:block}
.global-panel h4{font-size:.8rem;text-align:center;margin-bottom:.5rem}
.global-panel .gp-colors{display:flex;gap:.4rem;margin-bottom:.5rem;justify-content:center;flex-wrap:wrap}
.global-panel .gp-color-item{display:flex;align-items:center;gap:.25rem;font-size:.65rem;color:var(--sub)}
.global-panel .gp-color-item input[type="color"]{width:26px;height:26px;border:2px solid var(--border);border-radius:6px;cursor:pointer;padding:1px;background:var(--card);-webkit-appearance:none;appearance:none}
.global-panel .gp-color-item input[type="color"]::-webkit-color-swatch-wrapper{padding:1px}
.global-panel .gp-color-item input[type="color"]::-webkit-color-swatch{border-radius:4px;border:none}
.global-panel .gp-presets{display:grid;grid-template-columns:repeat(4,1fr);gap:.25rem;margin-bottom:.5rem}
.global-panel .gp-presets button{padding:.3rem .15rem;border:1.5px solid var(--border);border-radius:6px;background:var(--card);cursor:pointer;text-align:center;font-size:.58rem;color:var(--text);transition:.15s}
.global-panel .gp-presets button:hover{border-color:var(--accent)}
.global-panel .gp-actions{display:flex;gap:.3rem}
.global-panel .gp-actions button{flex:1;padding:.35rem;border:1.5px solid var(--accent);border-radius:8px;font-size:.72rem;cursor:pointer;transition:.15s}
.global-panel .gp-actions .gp-apply{background:var(--accent);color:#fff;border-color:var(--accent)}
.global-panel .gp-actions .gp-reset{background:transparent;color:var(--sub);border-color:var(--border)}
.global-color-indicator{display:inline-flex;gap:2px;margin-left:.3rem}
.global-color-indicator span{width:8px;height:8px;border-radius:50%;border:1px solid rgba(0,0,0,.1)}

footer{text-align:center;padding:1.5rem;color:var(--sub);font-size:.75rem;border-top:1px solid var(--border)}
footer a{color:var(--accent)}

/* 진행 표시 */
.progress-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;justify-content:center;align-items:center}
.progress-overlay.show{display:flex}
.progress-box{background:var(--card);border-radius:16px;padding:2rem;text-align:center;min-width:280px}
.progress-box h3{font-size:.95rem;margin-bottom:.8rem}
.progress-bar{width:100%;height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-bottom:.5rem}
.progress-bar-fill{height:100%;background:var(--accent);border-radius:4px;transition:width .2s;width:0%}
.progress-text{font-size:.78rem;color:var(--sub)}
</style>
</head>
<body>
<header>
  <h1>석리송의 교육용 SVG 아이콘 라이브러리</h1>
  <p class="subtitle">정보교육 · 디자인씽킹 · 프로젝트 수업 · STEAM 융합</p>
  <div class="search-box">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
    <input type="search" id="q" placeholder="아이콘 검색 (예: 변수, 프로토타입, 루브릭, 모둠활동...)">
  </div>
  <div class="toolbar">
    <span class="stats" id="stats"></span>
    <div class="view-btns">
      <button class="active" data-v="grid">그리드</button>
      <button data-v="table">문서</button>
    </div>
    <div class="global-panel-wrap">
      <button class="global-color-btn" id="globalColorBtn">&#127912; 전체 색상 변경</button>
      <div class="global-panel" id="globalPanel"></div>
    </div>
    <a class="doc-link" href="catalog.csv" download>CSV 다운로드</a>
    <a class="doc-link" href="catalog.json" download>JSON 다운로드</a>
  </div>
</header>

<!-- 포맷 선택 바 -->
<div class="format-bar">
  <label>다운로드 포맷:</label>
  <div class="format-btns" id="formatBtns">
    <button class="active" data-f="svg">SVG</button>
    <button data-f="png-32">PNG 32</button>
    <button data-f="png-64">PNG 64</button>
    <button data-f="png-128">PNG 128</button>
    <button data-f="png-256">PNG 256</button>
  </div>
  <button class="dl-all-btn" id="dlAllBtn" title="현재 보이는 아이콘 전체 다운로드">
    <svg viewBox="0 0 24 24" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    전체 다운로드 (ZIP)
  </button>
</div>

<nav id="cats"></nav>

<!-- 선택 도구 바 -->
<div class="select-bar" id="selectBar">
  <span class="sel-count" id="selCount">0개 선택</span>
  <button class="sel-all-btn" id="selAllBtn">전체 선택</button>
  <button class="sel-clear-btn" id="selClearBtn">선택 해제</button>
  <button class="sel-dl-btn" id="selDlBtn">
    <svg viewBox="0 0 24 24" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    선택 다운로드 (ZIP)
  </button>
</div>

<div class="grid" id="grid"></div>
<table class="doc-table hidden" id="docTable">
  <thead><tr><th>이미지</th><th>이름</th><th>파일명</th><th>카테고리</th><th>설명</th><th>사용 상황</th><th>다운로드</th></tr></thead>
  <tbody id="docBody"></tbody>
</table>
<div class="modal-bg" id="modalBg">
  <div class="modal" id="modal"></div>
</div>

<!-- 진행 표시 오버레이 -->
<div class="progress-overlay" id="progressOverlay">
  <div class="progress-box">
    <h3 id="progressTitle">다운로드 준비 중...</h3>
    <div class="progress-bar"><div class="progress-bar-fill" id="progressFill"></div></div>
    <p class="progress-text" id="progressText">0 / 0</p>
  </div>
</div>

<footer>
  석리송의 교육용 SVG 아이콘 라이브러리 · 기반: <a href="https://lucide.dev" target="_blank">Lucide</a> + <a href="https://tabler.io/icons" target="_blank">Tabler Icons</a> (MIT License)
</footer>
<script>
const CN={'01-devices':'컴퓨터와 디지털 기기','02-physical-computing':'피지컬컴퓨팅과 메이킹','03-programming':'소프트웨어와 프로그래밍','04-algorithm':'알고리즘과 자료구조','05-network-security':'네트워크와 정보보안','06-data-ai':'데이터와 인공지능','07-design-thinking':'디자인씽킹과 문제해결','08-steam':'STEAM 융합','09-teaching':'수업 활동과 평가','10-visual-symbols':'시각 기호와 안내 요소','11-numbers':'숫자와 번호','12-shapes':'도형과 입체'};
let all=[],activeCat='all',view='grid';
let dlFormats=new Set(['svg']); // 다중 포맷 선택
let selected=new Set(); // category/filename 기준 선택 관리
let globalColor=null; // 전역 색상 커스텀 상태 {grad1,grad2,bg,border}
const svgCache={}; // SVG 텍스트 캐시

fetch('catalog.json').then(r=>r.json()).then(d=>{
  all=d.icons;
  document.getElementById('stats').textContent=`총 ${d.totalCount}개`;
  buildCats(d.categories);
  render();
});

/* 포맷 선택 (다중) */
document.getElementById('formatBtns').onclick=e=>{
  if(!e.target.dataset.f)return;
  const f=e.target.dataset.f;
  if(dlFormats.has(f)){
    if(dlFormats.size>1) dlFormats.delete(f); // 최소 1개는 유지
  } else {
    dlFormats.add(f);
  }
  document.querySelectorAll('#formatBtns button').forEach(b=>b.classList.toggle('active',dlFormats.has(b.dataset.f)));
  render();
};

function formatsLabel(){
  return [...dlFormats].map(f=>formatLabel(f)).join('+');
}

function buildCats(cats){
  const n=document.getElementById('cats');
  n.innerHTML='<button class="active" data-c="all">전체</button>'+cats.map(c=>'<button data-c="'+c.id+'">'+c.name+' ('+c.count+')</button>').join('');
  n.onclick=e=>{if(!e.target.dataset.c)return;activeCat=e.target.dataset.c;n.querySelectorAll('button').forEach(b=>b.classList.toggle('active',b.dataset.c===activeCat));render()};
}

document.querySelector('.view-btns').onclick=e=>{
  if(!e.target.dataset.v)return;
  view=e.target.dataset.v;
  document.querySelectorAll('.view-btns button').forEach(b=>b.classList.toggle('active',b.dataset.v===view));
  render();
};

function filter(){
  const q=(document.getElementById('q').value||'').toLowerCase();
  return all.filter(i=>{
    if(activeCat!=='all'&&i.category!==activeCat)return false;
    if(!q)return true;
    return i.name.includes(q)||i.description.includes(q)||i.useCases.includes(q)||(CN[i.category]||'').includes(q);
  });
}

/* 파일 경로 헬퍼 */
function getFilePath(ic, fmt){
  const base=ic.filename.replace('.svg','');
  if(fmt==='svg') return {path:'svg/'+ic.category+'/'+ic.filename, name:ic.filename};
  const size=fmt.split('-')[1];
  return {path:'png/'+size+'/'+ic.category+'/'+base+'.png', name:base+'.png'};
}

function formatLabel(fmt){
  if(fmt==='svg') return 'SVG';
  return 'PNG '+fmt.split('-')[1]+'px';
}

/* 개별 다운로드 (단일 포맷) */
async function dlOne(ic, fmt){
  if(globalColor){
    const svgText=await fetchSvgText('svg/'+ic.category+'/'+ic.filename);
    const modified=applySvgColors(svgText,globalColor);
    if(fmt==='svg'){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([modified],{type:'image/svg+xml'}));
      a.download=ic.filename;a.click();URL.revokeObjectURL(a.href);
    } else {
      const size=parseInt(fmt.split('-')[1]);
      const pngBlob=await svgToPngBlob(modified,size);
      const a=document.createElement('a');
      a.href=URL.createObjectURL(pngBlob);
      a.download=ic.filename.replace('.svg','.png');a.click();URL.revokeObjectURL(a.href);
    }
    return;
  }
  const f=getFilePath(ic, fmt);
  fetch(f.path).then(r=>{
    if(!r.ok) throw new Error('파일 없음');
    return r.blob();
  }).then(b=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(b);
    a.download=f.name;
    a.click();
    URL.revokeObjectURL(a.href);
  }).catch(()=>alert('파일을 찾을 수 없습니다: '+f.path));
}

/* 개별 다운로드 (선택된 포맷들) */
async function dlFile(ic){
  const fmts=[...dlFormats];
  if(fmts.length===1){
    dlOne(ic, fmts[0]);
    return;
  }
  // 다중 포맷 → ZIP
  const zip=new JSZip();
  const base=ic.filename.replace('.svg','');
  for(const fmt of fmts){
    const f=getFilePath(ic, fmt);
    try{
      const r=await fetch(f.path);
      if(r.ok){
        const b=await r.blob();
        const folder=fmt==='svg'?'svg':'png-'+fmt.split('-')[1];
        zip.file(folder+'/'+f.name, b);
      }
    }catch(e){}
  }
  const blob=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=base+'-multi.zip';
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ZIP 다운로드 공통 함수 */
async function dlZip(icons, filePrefix){
  if(!icons.length){alert('다운로드할 아이콘이 없습니다.');return}
  const fmts=[...dlFormats];
  const total=icons.length*fmts.length;

  const overlay=document.getElementById('progressOverlay');
  const fill=document.getElementById('progressFill');
  const text=document.getElementById('progressText');
  const title=document.getElementById('progressTitle');
  title.textContent=formatsLabel()+' 다운로드 준비 중...';
  fill.style.width='0%';
  text.textContent='0 / '+total;
  overlay.classList.add('show');

  const zip=new JSZip();
  let done=0;
  const multiFormat=fmts.length>1;

  for(const ic of icons){
    for(const fmt of fmts){
      const f=getFilePath(ic, fmt);
      const folder=multiFormat?(fmt==='svg'?'svg':'png-'+fmt.split('-')[1])+'/':'';
      try{
        const r=await fetch(f.path);
        if(r.ok){const b=await r.blob();zip.file(folder+ic.category+'/'+f.name,b)}
      }catch(e){}
      done++;
      fill.style.width=Math.round(done/total*100)+'%';
      text.textContent=done+' / '+total;
    }
  }

  title.textContent='ZIP 파일 생성 중...';
  const blob=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filePrefix+'.zip';
  a.click();
  URL.revokeObjectURL(a.href);
  overlay.classList.remove('show');
}

/* 전체 다운로드 (ZIP) */
document.getElementById('dlAllBtn').onclick=async function(){
  this.disabled=true;
  const catSuffix=activeCat!=='all'?'-'+activeCat:'';
  await dlZip(filter(), 'icons-all'+catSuffix);
  this.disabled=false;
};

const checkSvg='<svg viewBox="0 0 24 24" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
const infoSvg='<svg viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>';

function icKey(ic){return ic.category+'/'+ic.filename}

function toggleSelect(ic){
  const k=icKey(ic);
  if(selected.has(k)) selected.delete(k); else selected.add(k);
  updateSelectUI();
}

function updateSelectUI(){
  const bar=document.getElementById('selectBar');
  if(selected.size>0){
    bar.classList.add('show');
    document.getElementById('selCount').textContent=selected.size+'개 선택';
  } else {
    bar.classList.remove('show');
  }
  // 카드 선택 상태 반영
  document.querySelectorAll('.card[data-key]').forEach(c=>{
    c.classList.toggle('selected',selected.has(c.dataset.key));
  });
  // 테이블 행 선택 상태 반영
  document.querySelectorAll('#docBody tr[data-key]').forEach(r=>{
    r.classList.toggle('selected',selected.has(r.dataset.key));
  });
}

/* 전체 선택 */
document.getElementById('selAllBtn').onclick=()=>{
  filter().forEach(ic=>selected.add(icKey(ic)));
  updateSelectUI();
};

/* 선택 해제 */
document.getElementById('selClearBtn').onclick=()=>{
  selected.clear();
  updateSelectUI();
};

/* 선택 다운로드 (ZIP) */
document.getElementById('selDlBtn').onclick=async function(){
  if(!selected.size){alert('선택된 아이콘이 없습니다.');return}
  this.disabled=true;
  await dlZip(all.filter(ic=>selected.has(icKey(ic))), 'icons-selected');
  this.disabled=false;
  selected.clear();
  updateSelectUI();
};

function render(){
  const f=filter();
  document.getElementById('stats').textContent=f.length===all.length?`총 ${all.length}개`:`${f.length} / ${all.length}개`;
  const g=document.getElementById('grid'),t=document.getElementById('docTable');
  if(view==='grid'){
    g.classList.remove('hidden');t.classList.add('hidden');
    if(!f.length){g.innerHTML='<p class="empty">검색 결과가 없습니다</p>';return}
    g.innerHTML=f.map((ic,i)=>{
      const k=icKey(ic);
      const sel=selected.has(k)?'selected':'';
      return '<div class="card '+sel+'" data-i="'+i+'" data-key="'+k+'">'+
        '<span class="card-check">'+checkSvg+'</span>'+
        '<button class="card-info" title="상세 보기">'+infoSvg+'</button>'+
        '<img src="svg/'+ic.category+'/'+ic.filename+'" alt="'+ic.name+'" loading="lazy">'+
        '<span>'+ic.name+'</span></div>';
    }).join('');
    if(globalColor) applyGlobalColorToVisible();
    g.querySelectorAll('.card').forEach(c=>{
      c.onclick=e=>{
        if(e.target.closest('.card-info')){
          e.stopPropagation();
          showModal(f[+c.dataset.i]);
          return;
        }
        // 클릭 시 바로 다운로드 + 선택 표시
        const ic=f[+c.dataset.i];
        dlFile(ic);
        selected.add(icKey(ic));
        updateSelectUI();
      };
      // 체크 영역 클릭은 선택만 (다운로드 없이)
      const chk=c.querySelector('.card-check');
      if(chk) chk.onclick=e=>{
        e.stopPropagation();
        toggleSelect(f[+c.dataset.i]);
      };
    });
  } else {
    g.classList.add('hidden');t.classList.remove('hidden');
    const b=document.getElementById('docBody');
    if(!f.length){b.innerHTML='<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--sub)">검색 결과가 없습니다</td></tr>';return}
    b.innerHTML=f.map((ic,i)=>{
      const k=icKey(ic);
      const sel=selected.has(k)?'selected':'';
      return '<tr class="'+sel+'" style="cursor:pointer" data-i="'+i+'" data-key="'+k+'">'+
        '<td><input type="checkbox" class="row-chk" '+(selected.has(k)?'checked':'')+'> <img src="svg/'+ic.category+'/'+ic.filename+'" alt="'+ic.name+'"></td>'+
        '<td><strong>'+ic.name+'</strong></td><td class="fname">'+ic.filename+'</td>'+
        '<td><span class="cat-badge">'+(CN[ic.category]||ic.category)+'</span></td>'+
        '<td>'+ic.description+'</td><td>'+ic.useCases+'</td>'+
        '<td><button class="row-dl">'+formatsLabel()+'</button></td></tr>';
    }).join('');
    if(globalColor) applyGlobalColorToVisible();
    b.querySelectorAll('tr').forEach(tr=>{
      tr.onclick=e=>{
        if(e.target.closest('.row-chk')){
          toggleSelect(f[+tr.dataset.i]);
          return;
        }
        if(e.target.closest('.row-dl')){
          e.stopPropagation();
          const ic=f[+tr.dataset.i];
          dlFile(ic);
          selected.add(icKey(ic));
          updateSelectUI();
          return;
        }
        const ic=f[+tr.dataset.i];
        if(ic) showModal(ic);
      };
    });
  }
  updateSelectUI();
}

function showModal(ic){
  const svgPath='svg/'+ic.category+'/'+ic.filename;
  const base=ic.filename.replace('.svg','');
  const formats=[
    {fmt:'svg', label:'SVG', sub:'벡터'},
    {fmt:'png-32', label:'PNG', sub:'32px'},
    {fmt:'png-64', label:'PNG', sub:'64px'},
    {fmt:'png-128', label:'PNG', sub:'128px'},
    {fmt:'png-256', label:'PNG', sub:'256px'},
  ];
  const dlBtns=formats.map(f=>{
    const cls=dlFormats.has(f.fmt)?'primary':'';
    return '<button class="'+cls+'" data-fmt="'+f.fmt+'">'+f.label+'<span class="sz">'+f.sub+'</span></button>';
  }).join('');

  document.getElementById('modal').innerHTML=
    '<button class="close">&times;</button>'+
    '<img src="'+svgPath+'" alt="'+ic.name+'">'+
    '<h2>'+ic.name+'</h2>'+
    '<p class="cat">'+(CN[ic.category]||ic.category)+'</p>'+
    '<p class="desc">'+ic.description+'</p>'+
    '<div class="meta">'+
      '<div><strong>파일명: </strong>'+ic.filename+'</div>'+
      '<div><strong>경로: </strong>svg/'+ic.category+'/'+ic.filename+'</div>'+
      '<div><strong>사용 상황: </strong>'+ic.useCases+'</div>'+
    '</div>'+
    '<div class="dl-section"><label>다운로드 (포맷 선택)</label><div class="dl-grid" id="modalDlGrid">'+dlBtns+'</div></div>'+
    '<div class="btns"><button onclick="copySvg(\''+svgPath+'\')">SVG 코드 복사</button></div>'+
    '<button class="color-edit-btn" id="colorEditBtn">&#127912; 색상 편집</button>'+
    '<div class="color-panel" id="colorPanel"></div>';

  document.getElementById('modalDlGrid').querySelectorAll('button').forEach(btn=>{
    btn.onclick=()=>dlOne(ic, btn.dataset.fmt);
  });
  document.getElementById('colorEditBtn').onclick=()=>toggleColorPanel(svgPath);

  const closeModal=()=>{document.getElementById('modalBg').classList.remove('show');document.getElementById('modal').classList.remove('color-mode');colorState=null};
  document.getElementById('modal').querySelector('.close').onclick=closeModal;
  document.getElementById('modalBg').classList.add('show');
}
document.getElementById('modalBg').onclick=e=>{if(e.target.id==='modalBg'){e.target.classList.remove('show');document.getElementById('modal').classList.remove('color-mode');colorState=null}};
document.getElementById('q').addEventListener('input',render);
function copySvg(p){fetch(p).then(r=>r.text()).then(t=>{navigator.clipboard.writeText(t).then(()=>alert('SVG 코드가 복사되었습니다!'))})}

/* ===== 색상 커스텀 기능 ===== */
let colorState=null;
const COLOR_PRESETS=[
  {name:'오션 블루',grad1:'#2563eb',grad2:'#60a5fa',bg:'#eff6ff',border:'#2563eb'},
  {name:'에메랄드',grad1:'#059669',grad2:'#34d399',bg:'#ecfdf5',border:'#059669'},
  {name:'선셋 오렌지',grad1:'#ea580c',grad2:'#fb923c',bg:'#fff7ed',border:'#ea580c'},
  {name:'로즈 핑크',grad1:'#e11d48',grad2:'#fb7185',bg:'#fff1f2',border:'#e11d48'},
  {name:'로열 퍼플',grad1:'#7c3aed',grad2:'#a78bfa',bg:'#f5f3ff',border:'#7c3aed'},
  {name:'사이버 틸',grad1:'#0891b2',grad2:'#22d3ee',bg:'#ecfeff',border:'#0891b2'},
  {name:'골든 앰버',grad1:'#b45309',grad2:'#fbbf24',bg:'#fffbeb',border:'#b45309'},
  {name:'포레스트',grad1:'#15803d',grad2:'#86efac',bg:'#f0fdf4',border:'#15803d'},
  {name:'미드나잇',grad1:'#60a5fa',grad2:'#93c5fd',bg:'#1e293b',border:'#334155'},
  {name:'슬레이트',grad1:'#334155',grad2:'#94a3b8',bg:'#f8fafc',border:'#334155'},
  {name:'체리 레드',grad1:'#dc2626',grad2:'#f87171',bg:'#fef2f2',border:'#dc2626'},
  {name:'라벤더',grad1:'#9333ea',grad2:'#d8b4fe',bg:'#faf5ff',border:'#9333ea'},
  {name:'코럴',grad1:'#f43f5e',grad2:'#fda4af',bg:'#fff1f2',border:'#f43f5e'},
  {name:'인디고',grad1:'#4338ca',grad2:'#818cf8',bg:'#eef2ff',border:'#4338ca'},
  {name:'민트',grad1:'#0d9488',grad2:'#5eead4',bg:'#f0fdfa',border:'#0d9488'},
  {name:'모노 화이트',grad1:'#1e293b',grad2:'#64748b',bg:'#ffffff',border:'#e2e8f0'},
];

function extractColors(svgText){
  const doc=new DOMParser().parseFromString(svgText,'image/svg+xml');
  const stops=doc.querySelectorAll('linearGradient stop');
  const rects=doc.querySelectorAll('rect');
  return{
    grad1:stops[0]?.getAttribute('stop-color')||'#2563eb',
    grad2:stops[1]?.getAttribute('stop-color')||'#60a5fa',
    bg:rects[0]?.getAttribute('fill')||'#eff6ff',
    border:rects[1]?.getAttribute('stroke')||'#2563eb'
  };
}

function applySvgColors(svgText,colors){
  const doc=new DOMParser().parseFromString(svgText,'image/svg+xml');
  const stops=doc.querySelectorAll('linearGradient stop');
  const rects=doc.querySelectorAll('rect');
  if(stops[0])stops[0].setAttribute('stop-color',colors.grad1);
  if(stops[1])stops[1].setAttribute('stop-color',colors.grad2);
  if(rects[0])rects[0].setAttribute('fill',colors.bg);
  if(rects[1])rects[1].setAttribute('stroke',colors.border);
  return new XMLSerializer().serializeToString(doc.documentElement);
}

function toggleColorPanel(svgPath){
  const panel=document.getElementById('colorPanel');
  const modal=document.getElementById('modal');
  if(panel.classList.contains('show')){
    panel.classList.remove('show');modal.classList.remove('color-mode');colorState=null;return;
  }
  modal.classList.add('color-mode');
  fetch(svgPath).then(r=>r.text()).then(svgText=>{
    const orig=extractColors(svgText);
    colorState={...orig,svgText,path:svgPath,orig:{...orig}};
    renderColorPanel();
  });
}

function renderColorPanel(){
  const panel=document.getElementById('colorPanel');
  const c=colorState;
  const fields=[
    {key:'grad1',label:'메인 색상 (시작)'},
    {key:'grad2',label:'메인 색상 (끝)'},
    {key:'bg',label:'배경 색상'},
    {key:'border',label:'테두리 색상'}
  ];
  const rows=fields.map(f=>
    '<div class="color-row"><label>'+f.label+'</label>'+
    '<input type="color" value="'+c[f.key]+'" data-key="'+f.key+'">'+
    '<input type="text" class="hex-input" value="'+c[f.key]+'" data-key="'+f.key+'"></div>'
  ).join('');
  const presets=COLOR_PRESETS.map((p,i)=>
    '<button class="preset-btn" data-pi="'+i+'">'+
    '<div class="preset-preview">'+
    '<span class="preset-swatch" style="background:'+p.bg+';border-color:'+p.border+'"></span>'+
    '<span class="preset-swatch" style="background:linear-gradient(135deg,'+p.grad1+','+p.grad2+')"></span>'+
    '</div>'+p.name+'</button>'
  ).join('');
  panel.innerHTML=
    '<h3>색상 편집</h3>'+rows+
    '<div class="preset-section"><label>추천 색상 팔레트</label><div class="preset-grid">'+presets+'</div></div>'+
    '<div class="color-preview-wrap" id="colorPreview"></div>'+
    '<div class="color-actions">'+
    '<button class="creset" id="cResetBtn">초기화</button>'+
    '<button class="ccopy" id="cCopyBtn">SVG 복사</button>'+
    '<button class="cdl" id="cDlBtn">SVG 다운로드</button>'+
    '</div>'+
    '<div class="color-actions" style="margin-top:.2rem">'+
    '<button class="cdl" id="cPngBtn">PNG 다운로드</button>'+
    '</div>'+
    '<div class="png-sizes hidden" id="pngSizes">'+
    '<button data-sz="32">32px</button><button data-sz="64">64px</button>'+
    '<button data-sz="128">128px</button><button data-sz="256">256px</button>'+
    '</div>';
  panel.classList.add('show');
  updateColorPreview();
  bindColorEvents();
}

function getCustomSvg(){
  return applySvgColors(colorState.svgText,colorState);
}

function updateColorPreview(){
  const wrap=document.getElementById('colorPreview');
  if(!wrap||!colorState)return;
  const svg=getCustomSvg();
  wrap.innerHTML=svg;
  const img=document.querySelector('#modal img');
  if(img){
    if(img._blobUrl)URL.revokeObjectURL(img._blobUrl);
    const url=URL.createObjectURL(new Blob([svg],{type:'image/svg+xml'}));
    img.src=url;img._blobUrl=url;
  }
}

function syncInputs(){
  ['grad1','grad2','bg','border'].forEach(k=>{
    const picker=document.querySelector('#colorPanel input[type="color"][data-key="'+k+'"]');
    const hex=document.querySelector('#colorPanel .hex-input[data-key="'+k+'"]');
    if(picker)picker.value=colorState[k];
    if(hex)hex.value=colorState[k];
  });
}

function bindColorEvents(){
  document.querySelectorAll('#colorPanel input[type="color"]').forEach(inp=>{
    inp.addEventListener('input',e=>{
      colorState[e.target.dataset.key]=e.target.value;
      const hex=document.querySelector('#colorPanel .hex-input[data-key="'+e.target.dataset.key+'"]');
      if(hex)hex.value=e.target.value;
      updateColorPreview();
    });
  });
  document.querySelectorAll('#colorPanel .hex-input').forEach(inp=>{
    inp.addEventListener('input',e=>{
      const v=e.target.value.trim();
      if(/^#[0-9a-fA-F]{6}$/.test(v)){
        colorState[e.target.dataset.key]=v;
        const picker=document.querySelector('#colorPanel input[type="color"][data-key="'+e.target.dataset.key+'"]');
        if(picker)picker.value=v;
        updateColorPreview();
      }
    });
  });
  document.querySelectorAll('.preset-btn').forEach(btn=>{
    btn.onclick=()=>{
      const p=COLOR_PRESETS[+btn.dataset.pi];
      colorState.grad1=p.grad1;colorState.grad2=p.grad2;colorState.bg=p.bg;colorState.border=p.border;
      syncInputs();updateColorPreview();
    };
  });
  document.getElementById('cResetBtn').onclick=()=>{
    colorState.grad1=colorState.orig.grad1;colorState.grad2=colorState.orig.grad2;
    colorState.bg=colorState.orig.bg;colorState.border=colorState.orig.border;
    syncInputs();updateColorPreview();
  };
  document.getElementById('cCopyBtn').onclick=()=>{
    navigator.clipboard.writeText(getCustomSvg()).then(()=>alert('커스텀 SVG 코드가 복사되었습니다!'));
  };
  document.getElementById('cDlBtn').onclick=()=>{
    const blob=new Blob([getCustomSvg()],{type:'image/svg+xml'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=colorState.path.split('/').pop().replace('.svg','-custom.svg');
    a.click();URL.revokeObjectURL(a.href);
  };
  document.getElementById('cPngBtn').onclick=()=>{
    document.getElementById('pngSizes').classList.toggle('hidden');
  };
  document.querySelectorAll('#pngSizes button').forEach(btn=>{
    btn.onclick=()=>downloadCustomPng(+btn.dataset.sz);
  });
}

function downloadCustomPng(size){
  const svg=getCustomSvg();
  const blob=new Blob([svg],{type:'image/svg+xml'});
  const url=URL.createObjectURL(blob);
  const img=new Image();
  img.onload=()=>{
    const canvas=document.createElement('canvas');
    canvas.width=size;canvas.height=size;
    const ctx=canvas.getContext('2d');
    ctx.drawImage(img,0,0,size,size);
    URL.revokeObjectURL(url);
    const a=document.createElement('a');
    a.href=canvas.toDataURL('image/png');
    a.download=colorState.path.split('/').pop().replace('.svg','-custom-'+size+'px.png');
    a.click();
  };
  img.src=url;
}

/* ===== 전체 색상 변경 기능 ===== */
async function fetchSvgText(path){
  if(svgCache[path]) return svgCache[path];
  const r=await fetch(path);
  const t=await r.text();
  svgCache[path]=t;
  return t;
}

function toggleGlobalPanel(){
  const panel=document.getElementById('globalPanel');
  const btn=document.getElementById('globalColorBtn');
  if(panel.classList.contains('show')){
    panel.classList.remove('show');btn.classList.remove('active');return;
  }
  btn.classList.add('active');
  const gc=globalColor||{grad1:'#2563eb',grad2:'#60a5fa',bg:'#eff6ff',border:'#2563eb'};
  const presets=COLOR_PRESETS.map((p,i)=>
    '<button data-pi="'+i+'">'+
    '<div class="preset-preview">'+
    '<span class="preset-swatch" style="background:'+p.bg+'"></span>'+
    '<span class="preset-swatch" style="background:linear-gradient(135deg,'+p.grad1+','+p.grad2+')"></span>'+
    '</div>'+p.name+'</button>'
  ).join('');
  panel.innerHTML=
    '<h4>전체 색상 변경</h4>'+
    '<div class="gp-colors">'+
    '<div class="gp-color-item"><input type="color" value="'+gc.grad1+'" data-key="grad1"><span>시작</span></div>'+
    '<div class="gp-color-item"><input type="color" value="'+gc.grad2+'" data-key="grad2"><span>끝</span></div>'+
    '<div class="gp-color-item"><input type="color" value="'+gc.bg+'" data-key="bg"><span>배경</span></div>'+
    '<div class="gp-color-item"><input type="color" value="'+gc.border+'" data-key="border"><span>선</span></div>'+
    '</div>'+
    '<div class="gp-presets">'+presets+'</div>'+
    '<div class="gp-actions">'+
    '<button class="gp-reset" id="gpResetBtn">원래 색상</button>'+
    '<button class="gp-apply" id="gpApplyBtn">적용</button>'+
    '</div>';
  panel.classList.add('show');

  // 프리셋 클릭
  panel.querySelectorAll('.gp-presets button').forEach(b=>{
    b.onclick=()=>{
      const p=COLOR_PRESETS[+b.dataset.pi];
      panel.querySelector('input[data-key="grad1"]').value=p.grad1;
      panel.querySelector('input[data-key="grad2"]').value=p.grad2;
      panel.querySelector('input[data-key="bg"]').value=p.bg;
      panel.querySelector('input[data-key="border"]').value=p.border;
    };
  });

  // 적용 버튼
  document.getElementById('gpApplyBtn').onclick=()=>{
    globalColor={
      grad1:panel.querySelector('input[data-key="grad1"]').value,
      grad2:panel.querySelector('input[data-key="grad2"]').value,
      bg:panel.querySelector('input[data-key="bg"]').value,
      border:panel.querySelector('input[data-key="border"]').value
    };
    panel.classList.remove('show');
    updateGlobalColorBtn();
    applyGlobalColorToVisible();
  };

  // 원래 색상 복원
  document.getElementById('gpResetBtn').onclick=()=>{
    globalColor=null;
    panel.classList.remove('show');
    updateGlobalColorBtn();
    render(); // 원본 이미지로 복원
  };
}

function updateGlobalColorBtn(){
  const btn=document.getElementById('globalColorBtn');
  btn.classList.toggle('active',!!globalColor);
  const existing=btn.querySelector('.global-color-indicator');
  if(existing) existing.remove();
  if(globalColor){
    const indicator=document.createElement('span');
    indicator.className='global-color-indicator';
    indicator.innerHTML='<span style="background:'+globalColor.grad1+'"></span><span style="background:'+globalColor.bg+'"></span>';
    btn.appendChild(indicator);
  }
}

async function applyGlobalColorToVisible(){
  if(!globalColor) return;
  const imgs=document.querySelectorAll('#grid .card img, #docBody img');
  const tasks=[];
  imgs.forEach(img=>{
    const origSrc=img.getAttribute('src');
    // blob URL이면 data-orig에서 원본 경로 사용
    const path=img.dataset.orig||origSrc;
    if(!path.startsWith('svg/')) return;
    img.dataset.orig=path;
    tasks.push((async()=>{
      const svgText=await fetchSvgText(path);
      const modified=applySvgColors(svgText,globalColor);
      if(img._blobUrl) URL.revokeObjectURL(img._blobUrl);
      const url=URL.createObjectURL(new Blob([modified],{type:'image/svg+xml'}));
      img.src=url;
      img._blobUrl=url;
    })());
  });
  await Promise.all(tasks);
}

// 패널 외부 클릭 시 닫기
document.addEventListener('click',e=>{
  const panel=document.getElementById('globalPanel');
  const btn=document.getElementById('globalColorBtn');
  if(panel.classList.contains('show')&&!panel.contains(e.target)&&!btn.contains(e.target)){
    panel.classList.remove('show');
    btn.classList.remove('active');
  }
});

document.getElementById('globalColorBtn').onclick=e=>{
  e.stopPropagation();
  toggleGlobalPanel();
};

// ZIP 다운로드에 전역 색상 적용
const origDlZip=dlZip;
dlZip=async function(icons,filePrefix){
  if(!globalColor) return origDlZip(icons,filePrefix);
  const fmts=[...dlFormats];
  // 전역 색상 적용 시 SVG만 색상 변경, PNG는 서버 파일 사용
  if(!fmts.includes('svg')&&fmts.every(f=>f.startsWith('png'))){
    return origDlZip(icons,filePrefix);
  }
  const total=icons.length*fmts.length;
  const overlay=document.getElementById('progressOverlay');
  const fill=document.getElementById('progressFill');
  const text=document.getElementById('progressText');
  const title=document.getElementById('progressTitle');
  title.textContent='커스텀 색상 '+formatsLabel()+' 준비 중...';
  fill.style.width='0%';text.textContent='0 / '+total;
  overlay.classList.add('show');
  const zip=new JSZip();
  let done=0;
  const multiFormat=fmts.length>1;
  for(const ic of icons){
    for(const fmt of fmts){
      const f=getFilePath(ic,fmt);
      const folder=multiFormat?(fmt==='svg'?'svg':'png-'+fmt.split('-')[1])+'/':'';
      try{
        if(fmt==='svg'){
          const svgText=await fetchSvgText(f.path);
          const modified=applySvgColors(svgText,globalColor);
          zip.file(folder+ic.category+'/'+f.name,modified);
        } else {
          // PNG도 커스텀 색상 적용
          const svgText=await fetchSvgText('svg/'+ic.category+'/'+ic.filename);
          const modified=applySvgColors(svgText,globalColor);
          const size=parseInt(fmt.split('-')[1]);
          const pngBlob=await svgToPngBlob(modified,size);
          zip.file(folder+ic.category+'/'+f.name,pngBlob);
        }
      }catch(e){}
      done++;
      fill.style.width=Math.round(done/total*100)+'%';
      text.textContent=done+' / '+total;
    }
  }
  title.textContent='ZIP 파일 생성 중...';
  const blob=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filePrefix+'-custom.zip';
  a.click();URL.revokeObjectURL(a.href);
  overlay.classList.remove('show');
};

function svgToPngBlob(svgText,size){
  return new Promise((resolve,reject)=>{
    const blob=new Blob([svgText],{type:'image/svg+xml'});
    const url=URL.createObjectURL(blob);
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      canvas.width=size;canvas.height=size;
      canvas.getContext('2d').drawImage(img,0,0,size,size);
      URL.revokeObjectURL(url);
      canvas.toBlob(b=>resolve(b),'image/png');
    };
    img.onerror=reject;
    img.src=url;
  });
}
</script>
</body>
</html>
