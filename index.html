<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>교육용 SVG 아이콘 라이브러리</title>
<script src="https://cdn.jsdelivr.net/npm/jszip@3/dist/jszip.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#f8fafc;--card:#fff;--text:#1e293b;--sub:#64748b;--border:#e2e8f0;--accent:#2563eb;--radius:12px}
@media(prefers-color-scheme:dark){:root{--bg:#0f172a;--card:#1e293b;--text:#f1f5f9;--sub:#94a3b8;--border:#334155;--accent:#60a5fa}}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
header{text-align:center;padding:2rem 1rem 1rem;max-width:800px;margin:0 auto}
h1{font-size:1.5rem;font-weight:700;margin-bottom:.2rem}
.subtitle{color:var(--sub);font-size:.85rem;margin-bottom:1rem}
.search-box{position:relative;max-width:500px;margin:0 auto .8rem}
.search-box input{width:100%;padding:.65rem 1rem .65rem 2.4rem;border:1.5px solid var(--border);border-radius:var(--radius);background:var(--card);color:var(--text);font-size:.9rem;outline:none}
.search-box input:focus{border-color:var(--accent)}
.search-box svg{position:absolute;left:.7rem;top:50%;transform:translateY(-50%);width:16px;height:16px;stroke:var(--sub)}
.toolbar{display:flex;justify-content:center;align-items:center;gap:.8rem;margin-bottom:.5rem;flex-wrap:wrap}
.stats{color:var(--sub);font-size:.8rem}
.view-btns{display:flex;gap:2px;border:1.5px solid var(--border);border-radius:8px;overflow:hidden}
.view-btns button{padding:.3rem .6rem;border:none;background:var(--card);color:var(--sub);font-size:.75rem;cursor:pointer}
.view-btns button.active{background:var(--accent);color:#fff}
.doc-link{font-size:.75rem;color:var(--accent);text-decoration:none;border:1px solid var(--accent);padding:.25rem .5rem;border-radius:6px;cursor:pointer}
.doc-link:hover{background:var(--accent);color:#fff}
nav{display:flex;flex-wrap:wrap;justify-content:center;gap:.35rem;padding:0 1rem;margin-bottom:1.2rem;max-width:1100px;margin-left:auto;margin-right:auto}
nav button{padding:.3rem .6rem;border:1.5px solid var(--border);border-radius:8px;background:var(--card);color:var(--sub);font-size:.72rem;cursor:pointer;transition:.15s}
nav button:hover,nav button.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* 포맷 선택 바 */
.format-bar{display:flex;justify-content:center;align-items:center;gap:.6rem;padding:.6rem 1rem;margin:0 auto .8rem;max-width:700px;flex-wrap:wrap}
.format-bar label{font-size:.78rem;font-weight:600;color:var(--sub);white-space:nowrap}
.format-btns{display:flex;gap:2px;border:1.5px solid var(--border);border-radius:8px;overflow:hidden}
.format-btns button{padding:.3rem .55rem;border:none;background:var(--card);color:var(--sub);font-size:.72rem;cursor:pointer;transition:.15s;white-space:nowrap}
.format-btns button.active{background:var(--accent);color:#fff}
.format-btns button:hover:not(.active){background:color-mix(in srgb,var(--accent) 10%,var(--card))}
.dl-all-btn{font-size:.73rem;color:#fff;background:var(--accent);border:none;padding:.35rem .7rem;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:.3rem;transition:.15s}
.dl-all-btn:hover{opacity:.85}
.dl-all-btn:disabled{opacity:.5;cursor:not-allowed}
.dl-all-btn svg{width:14px;height:14px;stroke:currentColor;fill:none}

/* 그리드 뷰 */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(88px,1fr));gap:.7rem;padding:0 1rem 2rem;max-width:1200px;margin:0 auto}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:.5rem;text-align:center;cursor:pointer;transition:.15s;position:relative}
.card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
.card.selected{border-color:var(--accent);background:color-mix(in srgb,var(--accent) 8%,var(--card));box-shadow:0 0 0 2px color-mix(in srgb,var(--accent) 25%,transparent)}
.card img{width:52px;height:52px;display:block;margin:0 auto .2rem;pointer-events:none}
.card span{font-size:.6rem;color:var(--sub);display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;pointer-events:none}
.card .card-info{position:absolute;top:4px;right:4px;width:20px;height:20px;border-radius:50%;background:var(--sub);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:.15s}
.card:hover .card-info{opacity:1}
.card .card-info svg{width:12px;height:12px;stroke:#fff;fill:none}
.card .card-check{position:absolute;top:4px;left:4px;width:18px;height:18px;border-radius:50%;border:1.5px solid var(--border);background:var(--card);display:flex;align-items:center;justify-content:center;opacity:0;transition:.15s}
.card:hover .card-check,.card.selected .card-check{opacity:1}
.card.selected .card-check{background:var(--accent);border-color:var(--accent)}
.card.selected .card-check svg{stroke:#fff}
.card .card-check svg{width:12px;height:12px;stroke:var(--sub);fill:none}

/* 선택 도구 바 */
.select-bar{display:none;justify-content:center;align-items:center;gap:.8rem;padding:.5rem 1rem;margin:0 auto .5rem;max-width:700px;flex-wrap:wrap;background:color-mix(in srgb,var(--accent) 8%,var(--bg));border-radius:10px}
.select-bar.show{display:flex}
.select-bar .sel-count{font-size:.78rem;color:var(--accent);font-weight:600}
.select-bar button{font-size:.73rem;padding:.3rem .65rem;border-radius:8px;cursor:pointer;border:1.5px solid var(--accent);transition:.15s}
.select-bar .sel-all-btn{background:transparent;color:var(--accent)}
.select-bar .sel-all-btn:hover{background:var(--accent);color:#fff}
.select-bar .sel-clear-btn{background:transparent;color:var(--sub);border-color:var(--border)}
.select-bar .sel-clear-btn:hover{border-color:var(--sub)}
.select-bar .sel-dl-btn{background:var(--accent);color:#fff;border-color:var(--accent);display:flex;align-items:center;gap:.3rem}
.select-bar .sel-dl-btn:hover{opacity:.85}
.select-bar .sel-dl-btn svg{width:13px;height:13px;stroke:currentColor;fill:none}

/* 테이블(문서) 뷰 */
.doc-table{width:100%;max-width:1100px;margin:0 auto 2rem;border-collapse:collapse;padding:0 1rem}
.doc-table th{background:var(--accent);color:#fff;padding:.5rem .7rem;font-size:.75rem;text-align:left;position:sticky;top:0}
.doc-table td{padding:.45rem .7rem;border-bottom:1px solid var(--border);font-size:.78rem;vertical-align:middle}
.doc-table tr:hover td{background:color-mix(in srgb,var(--accent) 5%,var(--card))}
.doc-table img{width:36px;height:36px;vertical-align:middle}
.doc-table .fname{font-family:monospace;font-size:.7rem;color:var(--sub)}
.doc-table .cat-badge{display:inline-block;padding:1px 6px;border-radius:4px;font-size:.65rem;background:color-mix(in srgb,var(--accent) 12%,var(--card));color:var(--accent)}
.doc-table .row-dl{background:none;border:1px solid var(--accent);color:var(--accent);padding:2px 8px;border-radius:6px;font-size:.68rem;cursor:pointer;transition:.15s}
.doc-table .row-dl:hover{background:var(--accent);color:#fff}
.doc-table tr.selected td{background:color-mix(in srgb,var(--accent) 8%,var(--card))}
.doc-table .row-chk{width:15px;height:15px;accent-color:var(--accent);cursor:pointer;vertical-align:middle;margin-right:4px}

.hidden{display:none!important}

/* 모달 */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:100;justify-content:center;align-items:center}
.modal-bg.show{display:flex}
.modal{background:var(--card);border-radius:16px;padding:1.5rem;max-width:420px;width:92%;max-height:85vh;overflow-y:auto;position:relative}
.modal .close{position:absolute;top:.7rem;right:.7rem;background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--sub)}
.modal img{width:100px;height:100px;display:block;margin:0 auto .8rem}
.modal h2{font-size:1rem;text-align:center;margin-bottom:.2rem}
.modal .cat{text-align:center;color:var(--accent);font-size:.78rem;margin-bottom:.6rem}
.modal .desc{color:var(--sub);font-size:.82rem;margin-bottom:.4rem}
.modal .meta{font-size:.75rem;margin-bottom:.8rem;padding:.5rem;background:var(--bg);border-radius:8px}
.modal .meta div{margin-bottom:.3rem}
.modal .meta strong{color:var(--sub);font-size:.7rem}
.modal .dl-section{margin-bottom:.6rem}
.modal .dl-section label{font-size:.72rem;color:var(--sub);font-weight:600;display:block;margin-bottom:.3rem}
.modal .dl-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.35rem}
.modal .dl-grid button{padding:.4rem .3rem;border:1.5px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);font-size:.72rem;cursor:pointer;transition:.15s;text-align:center}
.modal .dl-grid button:hover{border-color:var(--accent);color:var(--accent)}
.modal .dl-grid button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.modal .dl-grid button .sz{display:block;font-size:.62rem;color:var(--sub);margin-top:1px}
.modal .dl-grid button.primary .sz{color:rgba(255,255,255,.7)}
.modal .btns{display:flex;gap:.5rem}
.modal .btns button{flex:1;padding:.45rem;border:1.5px solid var(--accent);border-radius:8px;background:transparent;color:var(--accent);font-size:.78rem;cursor:pointer}
.modal .btns button:first-child{background:var(--accent);color:#fff}
.empty{text-align:center;color:var(--sub);padding:3rem;grid-column:1/-1}
footer{text-align:center;padding:1.5rem;color:var(--sub);font-size:.75rem;border-top:1px solid var(--border)}
footer a{color:var(--accent)}

/* 진행 표시 */
.progress-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;justify-content:center;align-items:center}
.progress-overlay.show{display:flex}
.progress-box{background:var(--card);border-radius:16px;padding:2rem;text-align:center;min-width:280px}
.progress-box h3{font-size:.95rem;margin-bottom:.8rem}
.progress-bar{width:100%;height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-bottom:.5rem}
.progress-bar-fill{height:100%;background:var(--accent);border-radius:4px;transition:width .2s;width:0%}
.progress-text{font-size:.78rem;color:var(--sub)}
</style>
</head>
<body>
<header>
  <h1>교육용 SVG 아이콘 라이브러리</h1>
  <p class="subtitle">정보교육 · 디자인씽킹 · 프로젝트 수업 · STEAM 융합</p>
  <div class="search-box">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
    <input type="search" id="q" placeholder="아이콘 검색 (예: 변수, 프로토타입, 루브릭, 모둠활동...)">
  </div>
  <div class="toolbar">
    <span class="stats" id="stats"></span>
    <div class="view-btns">
      <button class="active" data-v="grid">그리드</button>
      <button data-v="table">문서</button>
    </div>
    <a class="doc-link" href="catalog.csv" download>CSV 다운로드</a>
    <a class="doc-link" href="catalog.json" download>JSON 다운로드</a>
  </div>
</header>

<!-- 포맷 선택 바 -->
<div class="format-bar">
  <label>다운로드 포맷:</label>
  <div class="format-btns" id="formatBtns">
    <button class="active" data-f="svg">SVG</button>
    <button data-f="png-32">PNG 32</button>
    <button data-f="png-64">PNG 64</button>
    <button data-f="png-128">PNG 128</button>
    <button data-f="png-256">PNG 256</button>
  </div>
  <button class="dl-all-btn" id="dlAllBtn" title="현재 보이는 아이콘 전체 다운로드">
    <svg viewBox="0 0 24 24" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    전체 다운로드 (ZIP)
  </button>
</div>

<nav id="cats"></nav>

<!-- 선택 도구 바 -->
<div class="select-bar" id="selectBar">
  <span class="sel-count" id="selCount">0개 선택</span>
  <button class="sel-all-btn" id="selAllBtn">전체 선택</button>
  <button class="sel-clear-btn" id="selClearBtn">선택 해제</button>
  <button class="sel-dl-btn" id="selDlBtn">
    <svg viewBox="0 0 24 24" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    선택 다운로드 (ZIP)
  </button>
</div>

<div class="grid" id="grid"></div>
<table class="doc-table hidden" id="docTable">
  <thead><tr><th>이미지</th><th>이름</th><th>파일명</th><th>카테고리</th><th>설명</th><th>사용 상황</th><th>다운로드</th></tr></thead>
  <tbody id="docBody"></tbody>
</table>
<div class="modal-bg" id="modalBg">
  <div class="modal" id="modal"></div>
</div>

<!-- 진행 표시 오버레이 -->
<div class="progress-overlay" id="progressOverlay">
  <div class="progress-box">
    <h3 id="progressTitle">다운로드 준비 중...</h3>
    <div class="progress-bar"><div class="progress-bar-fill" id="progressFill"></div></div>
    <p class="progress-text" id="progressText">0 / 0</p>
  </div>
</div>

<footer>
  교육용 SVG 아이콘 라이브러리 · 기반: <a href="https://lucide.dev" target="_blank">Lucide</a> + <a href="https://tabler.io/icons" target="_blank">Tabler Icons</a> (MIT License)
</footer>
<script>
const CN={'01-devices':'컴퓨터와 디지털 기기','02-physical-computing':'피지컬컴퓨팅과 메이킹','03-programming':'소프트웨어와 프로그래밍','04-algorithm':'알고리즘과 자료구조','05-network-security':'네트워크와 정보보안','06-data-ai':'데이터와 인공지능','07-design-thinking':'디자인씽킹과 문제해결','08-steam':'STEAM 융합','09-teaching':'수업 활동과 평가','10-visual-symbols':'시각 기호와 안내 요소','11-numbers':'숫자와 번호','12-shapes':'도형과 입체'};
let all=[],activeCat='all',view='grid';
let dlFormats=new Set(['svg']); // 다중 포맷 선택
let selected=new Set(); // category/filename 기준 선택 관리

fetch('catalog.json').then(r=>r.json()).then(d=>{
  all=d.icons;
  document.getElementById('stats').textContent=`총 ${d.totalCount}개`;
  buildCats(d.categories);
  render();
});

/* 포맷 선택 (다중) */
document.getElementById('formatBtns').onclick=e=>{
  if(!e.target.dataset.f)return;
  const f=e.target.dataset.f;
  if(dlFormats.has(f)){
    if(dlFormats.size>1) dlFormats.delete(f); // 최소 1개는 유지
  } else {
    dlFormats.add(f);
  }
  document.querySelectorAll('#formatBtns button').forEach(b=>b.classList.toggle('active',dlFormats.has(b.dataset.f)));
  render();
};

function formatsLabel(){
  return [...dlFormats].map(f=>formatLabel(f)).join('+');
}

function buildCats(cats){
  const n=document.getElementById('cats');
  n.innerHTML='<button class="active" data-c="all">전체</button>'+cats.map(c=>'<button data-c="'+c.id+'">'+c.name+' ('+c.count+')</button>').join('');
  n.onclick=e=>{if(!e.target.dataset.c)return;activeCat=e.target.dataset.c;n.querySelectorAll('button').forEach(b=>b.classList.toggle('active',b.dataset.c===activeCat));render()};
}

document.querySelector('.view-btns').onclick=e=>{
  if(!e.target.dataset.v)return;
  view=e.target.dataset.v;
  document.querySelectorAll('.view-btns button').forEach(b=>b.classList.toggle('active',b.dataset.v===view));
  render();
};

function filter(){
  const q=(document.getElementById('q').value||'').toLowerCase();
  return all.filter(i=>{
    if(activeCat!=='all'&&i.category!==activeCat)return false;
    if(!q)return true;
    return i.name.includes(q)||i.description.includes(q)||i.useCases.includes(q)||(CN[i.category]||'').includes(q);
  });
}

/* 파일 경로 헬퍼 */
function getFilePath(ic, fmt){
  const base=ic.filename.replace('.svg','');
  if(fmt==='svg') return {path:'svg/'+ic.category+'/'+ic.filename, name:ic.filename};
  const size=fmt.split('-')[1];
  return {path:'png/'+size+'/'+ic.category+'/'+base+'.png', name:base+'.png'};
}

function formatLabel(fmt){
  if(fmt==='svg') return 'SVG';
  return 'PNG '+fmt.split('-')[1]+'px';
}

/* 개별 다운로드 (단일 포맷) */
function dlOne(ic, fmt){
  const f=getFilePath(ic, fmt);
  fetch(f.path).then(r=>{
    if(!r.ok) throw new Error('파일 없음');
    return r.blob();
  }).then(b=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(b);
    a.download=f.name;
    a.click();
    URL.revokeObjectURL(a.href);
  }).catch(()=>alert('파일을 찾을 수 없습니다: '+f.path));
}

/* 개별 다운로드 (선택된 포맷들) */
async function dlFile(ic){
  const fmts=[...dlFormats];
  if(fmts.length===1){
    dlOne(ic, fmts[0]);
    return;
  }
  // 다중 포맷 → ZIP
  const zip=new JSZip();
  const base=ic.filename.replace('.svg','');
  for(const fmt of fmts){
    const f=getFilePath(ic, fmt);
    try{
      const r=await fetch(f.path);
      if(r.ok){
        const b=await r.blob();
        const folder=fmt==='svg'?'svg':'png-'+fmt.split('-')[1];
        zip.file(folder+'/'+f.name, b);
      }
    }catch(e){}
  }
  const blob=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=base+'-multi.zip';
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ZIP 다운로드 공통 함수 */
async function dlZip(icons, filePrefix){
  if(!icons.length){alert('다운로드할 아이콘이 없습니다.');return}
  const fmts=[...dlFormats];
  const total=icons.length*fmts.length;

  const overlay=document.getElementById('progressOverlay');
  const fill=document.getElementById('progressFill');
  const text=document.getElementById('progressText');
  const title=document.getElementById('progressTitle');
  title.textContent=formatsLabel()+' 다운로드 준비 중...';
  fill.style.width='0%';
  text.textContent='0 / '+total;
  overlay.classList.add('show');

  const zip=new JSZip();
  let done=0;
  const multiFormat=fmts.length>1;

  for(const ic of icons){
    for(const fmt of fmts){
      const f=getFilePath(ic, fmt);
      const folder=multiFormat?(fmt==='svg'?'svg':'png-'+fmt.split('-')[1])+'/':'';
      try{
        const r=await fetch(f.path);
        if(r.ok){const b=await r.blob();zip.file(folder+ic.category+'/'+f.name,b)}
      }catch(e){}
      done++;
      fill.style.width=Math.round(done/total*100)+'%';
      text.textContent=done+' / '+total;
    }
  }

  title.textContent='ZIP 파일 생성 중...';
  const blob=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filePrefix+'.zip';
  a.click();
  URL.revokeObjectURL(a.href);
  overlay.classList.remove('show');
}

/* 전체 다운로드 (ZIP) */
document.getElementById('dlAllBtn').onclick=async function(){
  this.disabled=true;
  const catSuffix=activeCat!=='all'?'-'+activeCat:'';
  await dlZip(filter(), 'icons-all'+catSuffix);
  this.disabled=false;
};

const checkSvg='<svg viewBox="0 0 24 24" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
const infoSvg='<svg viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>';

function icKey(ic){return ic.category+'/'+ic.filename}

function toggleSelect(ic){
  const k=icKey(ic);
  if(selected.has(k)) selected.delete(k); else selected.add(k);
  updateSelectUI();
}

function updateSelectUI(){
  const bar=document.getElementById('selectBar');
  if(selected.size>0){
    bar.classList.add('show');
    document.getElementById('selCount').textContent=selected.size+'개 선택';
  } else {
    bar.classList.remove('show');
  }
  // 카드 선택 상태 반영
  document.querySelectorAll('.card[data-key]').forEach(c=>{
    c.classList.toggle('selected',selected.has(c.dataset.key));
  });
  // 테이블 행 선택 상태 반영
  document.querySelectorAll('#docBody tr[data-key]').forEach(r=>{
    r.classList.toggle('selected',selected.has(r.dataset.key));
  });
}

/* 전체 선택 */
document.getElementById('selAllBtn').onclick=()=>{
  filter().forEach(ic=>selected.add(icKey(ic)));
  updateSelectUI();
};

/* 선택 해제 */
document.getElementById('selClearBtn').onclick=()=>{
  selected.clear();
  updateSelectUI();
};

/* 선택 다운로드 (ZIP) */
document.getElementById('selDlBtn').onclick=async function(){
  if(!selected.size){alert('선택된 아이콘이 없습니다.');return}
  this.disabled=true;
  await dlZip(all.filter(ic=>selected.has(icKey(ic))), 'icons-selected');
  this.disabled=false;
  selected.clear();
  updateSelectUI();
};

function render(){
  const f=filter();
  document.getElementById('stats').textContent=f.length===all.length?`총 ${all.length}개`:`${f.length} / ${all.length}개`;
  const g=document.getElementById('grid'),t=document.getElementById('docTable');
  if(view==='grid'){
    g.classList.remove('hidden');t.classList.add('hidden');
    if(!f.length){g.innerHTML='<p class="empty">검색 결과가 없습니다</p>';return}
    g.innerHTML=f.map((ic,i)=>{
      const k=icKey(ic);
      const sel=selected.has(k)?'selected':'';
      return '<div class="card '+sel+'" data-i="'+i+'" data-key="'+k+'">'+
        '<span class="card-check">'+checkSvg+'</span>'+
        '<button class="card-info" title="상세 보기">'+infoSvg+'</button>'+
        '<img src="svg/'+ic.category+'/'+ic.filename+'" alt="'+ic.name+'" loading="lazy">'+
        '<span>'+ic.name+'</span></div>';
    }).join('');
    g.querySelectorAll('.card').forEach(c=>{
      c.onclick=e=>{
        if(e.target.closest('.card-info')){
          e.stopPropagation();
          showModal(f[+c.dataset.i]);
          return;
        }
        // 클릭 시 바로 다운로드 + 선택 표시
        const ic=f[+c.dataset.i];
        dlFile(ic);
        selected.add(icKey(ic));
        updateSelectUI();
      };
      // 체크 영역 클릭은 선택만 (다운로드 없이)
      const chk=c.querySelector('.card-check');
      if(chk) chk.onclick=e=>{
        e.stopPropagation();
        toggleSelect(f[+c.dataset.i]);
      };
    });
  } else {
    g.classList.add('hidden');t.classList.remove('hidden');
    const b=document.getElementById('docBody');
    if(!f.length){b.innerHTML='<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--sub)">검색 결과가 없습니다</td></tr>';return}
    b.innerHTML=f.map((ic,i)=>{
      const k=icKey(ic);
      const sel=selected.has(k)?'selected':'';
      return '<tr class="'+sel+'" style="cursor:pointer" data-i="'+i+'" data-key="'+k+'">'+
        '<td><input type="checkbox" class="row-chk" '+(selected.has(k)?'checked':'')+'> <img src="svg/'+ic.category+'/'+ic.filename+'" alt="'+ic.name+'"></td>'+
        '<td><strong>'+ic.name+'</strong></td><td class="fname">'+ic.filename+'</td>'+
        '<td><span class="cat-badge">'+(CN[ic.category]||ic.category)+'</span></td>'+
        '<td>'+ic.description+'</td><td>'+ic.useCases+'</td>'+
        '<td><button class="row-dl">'+formatsLabel()+'</button></td></tr>';
    }).join('');
    b.querySelectorAll('tr').forEach(tr=>{
      tr.onclick=e=>{
        if(e.target.closest('.row-chk')){
          toggleSelect(f[+tr.dataset.i]);
          return;
        }
        if(e.target.closest('.row-dl')){
          e.stopPropagation();
          const ic=f[+tr.dataset.i];
          dlFile(ic);
          selected.add(icKey(ic));
          updateSelectUI();
          return;
        }
        const ic=f[+tr.dataset.i];
        if(ic) showModal(ic);
      };
    });
  }
  updateSelectUI();
}

function showModal(ic){
  const svgPath='svg/'+ic.category+'/'+ic.filename;
  const base=ic.filename.replace('.svg','');
  const formats=[
    {fmt:'svg', label:'SVG', sub:'벡터'},
    {fmt:'png-32', label:'PNG', sub:'32px'},
    {fmt:'png-64', label:'PNG', sub:'64px'},
    {fmt:'png-128', label:'PNG', sub:'128px'},
    {fmt:'png-256', label:'PNG', sub:'256px'},
  ];
  const dlBtns=formats.map(f=>{
    const cls=dlFormats.has(f.fmt)?'primary':'';
    return '<button class="'+cls+'" data-fmt="'+f.fmt+'">'+f.label+'<span class="sz">'+f.sub+'</span></button>';
  }).join('');

  document.getElementById('modal').innerHTML=
    '<button class="close">&times;</button>'+
    '<img src="'+svgPath+'" alt="'+ic.name+'">'+
    '<h2>'+ic.name+'</h2>'+
    '<p class="cat">'+(CN[ic.category]||ic.category)+'</p>'+
    '<p class="desc">'+ic.description+'</p>'+
    '<div class="meta">'+
      '<div><strong>파일명: </strong>'+ic.filename+'</div>'+
      '<div><strong>경로: </strong>svg/'+ic.category+'/'+ic.filename+'</div>'+
      '<div><strong>사용 상황: </strong>'+ic.useCases+'</div>'+
    '</div>'+
    '<div class="dl-section"><label>다운로드 (포맷 선택)</label><div class="dl-grid" id="modalDlGrid">'+dlBtns+'</div></div>'+
    '<div class="btns"><button onclick="copySvg(\''+svgPath+'\')">SVG 코드 복사</button></div>';

  document.getElementById('modalDlGrid').querySelectorAll('button').forEach(btn=>{
    btn.onclick=()=>dlOne(ic, btn.dataset.fmt);
  });

  document.getElementById('modal').querySelector('.close').onclick=()=>document.getElementById('modalBg').classList.remove('show');
  document.getElementById('modalBg').classList.add('show');
}
document.getElementById('modalBg').onclick=e=>{if(e.target.id==='modalBg')e.target.classList.remove('show')};
document.getElementById('q').addEventListener('input',render);
function copySvg(p){fetch(p).then(r=>r.text()).then(t=>{navigator.clipboard.writeText(t).then(()=>alert('SVG 코드가 복사되었습니다!'))})}
</script>
</body>
</html>
